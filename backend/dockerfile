# ----- Stage 1: Builder (مرحله ساخت و کامپایل) -----
    FROM node:20-alpine AS builder

    # تنظیم پوشه کاری داخل کانتینر
    WORKDIR /app
    
    # کپی کردن فایل‌های پکیج برای نصب وابستگی‌ها
    COPY package*.json ./
    COPY prisma ./prisma/
    
    # نصب تمام وابستگی‌ها (حتی devDependencies برای بیلد گرفتن)
    RUN npm ci
    
    # کپی کردن کل سورس‌کد
    COPY . .
    
    # ساخت کلاینت پریزما (بسیار مهم برای ارتباط با دیتابیس)
    RUN npx prisma generate
    
    # بیلد گرفتن از پروژه NestJS
    RUN npm run build
    
    
    # ----- Stage 2: Production (مرحله نهایی و اجرای سبک) -----
    FROM node:20-alpine AS production
    
    WORKDIR /app
    
    # تنظیم متغیر محیطی روی پروداکشن برای امنیت و سرعت بیشتر
    ENV NODE_ENV=production
    
    # کپی کردن فایل‌های پکیج
    COPY package*.json ./
    COPY prisma ./prisma/
    
    # این بار فقط وابستگی‌های اصلی (بدون پکیج‌های توسعه) نصب می‌شوند
    RUN npm ci --only=production
    
    # ساخت مجدد کلاینت پریزما برای محیط پروداکشن
    RUN npx prisma generate
    
    # کپی کردن پوشه کامپایل‌شده (dist) از مرحله قبل
    COPY --from=builder /app/dist ./dist
    
    # باز کردن پورت 4000 (پورت استاندارد بک‌اند شما که در فایروال هم باز بود)
    EXPOSE 4000
    
    # دستور نهایی برای روشن کردن سرور NestJS
    CMD ["npm", "run", "start:prod"]