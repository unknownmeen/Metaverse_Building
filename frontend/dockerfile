# ----- Stage 1: Builder (مرحله کامپایل و ساخت فایل‌های استاتیک) -----
    FROM node:20-alpine AS builder

    WORKDIR /app
    
    # کپی کردن فایل‌های پکیج
    COPY package*.json ./
    
    # نصب وابستگی‌ها
    RUN npm ci
    
    # کپی کل سورس‌کد فرانت‌اند
    COPY . .
    
    # بیلد گرفتن با Vite (خروجی در پوشه dist قرار می‌گیرد)
    RUN npm run build
    
    
    # ----- Stage 2: Production (مرحله اجرای وب‌سرور) -----
    FROM nginx:alpine AS production
    
    # پاک کردن فایل‌های پیش‌فرض انجین‌ایکس
    RUN rm -rf /usr/share/nginx/html/*
    
    # کپی کردن فایل‌های بیلد شده از مرحله قبل به پوشه انجین‌ایکس
    COPY --from=builder /app/dist /usr/share/nginx/html
    
    # تزریق تنظیمات اختصاصی برای پشتیبانی از React Router (جلوگیری از خطای 404)
    RUN echo "server { \
        listen 80; \
        location / { \
            root /usr/share/nginx/html; \
            index index.html index.htm; \
            try_files \$uri \$uri/ /index.html; \
        } \
    }" > /etc/nginx/conf.d/default.conf
    
    # باز کردن پورت 80 (پورت داخلی کانتینر فرانت‌اند)
    EXPOSE 80
    
    # روشن کردن انجین‌ایکس
    CMD ["nginx", "-g", "daemon off;"]